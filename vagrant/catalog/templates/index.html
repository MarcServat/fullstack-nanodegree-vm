<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Catalog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <!--LOAD PRE-REQUISITES FOR GOOGLE SIGN IN -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js">
    </script>
    <script src="//apis.google.com/js/platform.js?onload=start"> </script>
</head>
<body class="container">
    <header>
        {%if 'username' not in login_session %}
        <div id="signinButton">
            <span   class="g-signin"
                    data-scope="openid email"
                    data-clientid="517584791068-55gthfddul8inbc19tagv31g7omju3rh.apps.googleusercontent.com"
                    data-redirecturi="postmessage"
                    data-accesstype="offline"
                    data-cookiepolicy="single_host_origin"
                    data-callback="signInCallback"
                    data-approvalprompt="force">
            </span>
        </div>		
        {% else %}
			<a href="{{url_for('gdisconnect')}}">Logout </a>
		{% endif %}
    </header>
    
    <aside>
        <h3>Categories</h3>
        {% for category in categories %}
        <p>
            <a href="{{url_for('listItem',
                    category_name=category.name)}}">{{ category.name }}
            </a>
        </p>
        {% endfor %}        
    </aside>
    <section>
        {% if 'username' in login_session %}
            <a href="{{url_for('createCatalogItem')}}">Add item</a>
        {% endif %}
        <h3>Latest Items</h3>
        {% for item in items %}
            {% for category in categories %}
                {% if category.id == item.category_id %}
                    <p>
                        <a href="{{url_for('itemDescription',
                        category_name=category.name,
                        item_title=item.title)}}">{{ item.title }}</a>
                        ({{ category.name }})
                    </p>
                {% endif %}
            {% endfor %}
        {% endfor %}
    </section>
    <div id="result"></div>
    <script>
    function signInCallback(authResult) {
    if (authResult['code']) {
        // Hide the sign-in button now that the user is authorized
        $('#signinButton').attr('style', 'display: none');
        // Send the one-time-use code to the server, if the server responds, write a 'login successful' message to the web page and then redirect back to the main restaurants page
        $.ajax({
        type: 'POST',
        url: '/gconnect?state={{STATE}}',
        processData: false,
        data: authResult['code'],
        contentType: 'application/octet-stream; charset=utf-8',
        success: function(result) {
            // Handle or verify the server response if necessary.
            if (result) {
            $('#result').html('Login Successful!</br>'+ result + '</br>Redirecting...')
            setTimeout(function() {
            window.location.href = "/";
            }, 4000);
            
        } else if (authResult['error']) {
        console.log('There was an error: ' + authResult['error']);
    } else {
            $('#result').html('Failed to make a server-side call. Check your configuration and console.');
            }
        }
        
    }); } }
    </script>
</body>
</html>
